# 04. Promise ê´€ë ¨ saga ë¦¬íŒ©í† ë§

1. Promise ê¸°ë°˜ saga ë¹„ë™ê¸° ì‘ì—… ì‹œ `request action -> request success action -> request fail action` ìˆœì„œë¡œ dispatch í•˜ëŠ” ê³¼ì •ì´ ì¤‘ë³µë¨
2. 1ë²ˆ ê³¼ì •ì„ ì‰½ê²Œ saga í•¨ìˆ˜ë¡œ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ìœ í‹¸ í•¨ìˆ˜ ì‘ì„±
   * `createPromiseThunk`ì˜ saga ë²„ì „

* **src/modules/posts.js ì¤‘ ì¼ë¶€**
```javascript
/* ì¤‘ë³µë˜ëŠ” ë¹„ë™ê¸° ì²˜ë¦¬ saga ë¶€ë¶„ */

function* getPostsSaga() {
  try {
    const posts = yield call(postAPI.getPosts); // 1. promise ë°˜í™˜
    
    yield put({
      type: GET_POSTS_SUCCESS,
      payload: posts
    }); // 2. ì„±ê³µ action dispatch
  } catch (err) {
    yield put({
      type: GET_POSTS_ERROR,
      payload: err,
      error: true
    }); // 2. ì‹¤íŒ¨ action dispatch
  }
}

function* getPostSaga(action) {
  const id = action.payload;

  try {
    const post = yield call(postAPI.getPostById, id); // 1. paramì„ ì‚¬ìš©í•´ promise ë°˜í™˜

    yield put({
      type: GET_POSTS_SUCCESS,
      payload: post,
      meta: id
    }); // 2. ì„±ê³µ action dispatch
  } catch (err) {
    yield put({
      type: GET_POST_ERROR,
      payload: err,
      error: true,
      meta: id
    }); // 2. ì‹¤íŒ¨ action dispatxh
  }
}
```

* **src/lib/asyncUtils.js ì¤‘ ì¼ë¶€**
```javascript
/* createPromiseThunk() */

export const createPromiseThunk = (type, promiseCreator) => {
 const [SUCCESS, ERROR] = [`${type}_SUCCESS`, `${type}_ERROR`];
 
	return (param) => async (dispatch) => {
        dispatch({ type }); // 0. request action dispatch

		try {
          const payload = await promiseCreator(param); // 1. paramì„ ì‚¬ìš©í•´ promise ë°˜í™˜

          dispatch({
              type: SUCCESS,
              payload
          }); // 2. ì„±ê³µ action dispatch
		} catch (e) {
          dispatch({
              type: ERROR,
              payload: e,
              error: true
          }); // 2. ì‹¤íŒ¨ action dispatch
		}
	};
};
```

## ğŸ‘©â€ğŸ’» ì˜ˆì œ ì½”ë“œ

> **src/lib/asyncUtils.js ì¤‘ ì¼ë¶€**
```javascript
import { call, put } from "redux-saga/effects";

// promiseCreator: api í˜¸ì¶œ í›„ promise ë°˜í™˜ í•¨ìˆ˜
export const createPromiseSaga = (type, promiseCreator) => {
  const [SUCCESS, ERROR] = [`${type}_SUCCESS`, `${type}_ERROR`];

  return function* saga(action) {
    // ì´ë¦„ ìƒëµ ê°€ëŠ¥ (saga)
    // api ìš”ì²­ ì‹œ í•„ìš”í•œ íŒŒë¼ë¯¸í„°ëŠ” action.payloadë¡œ ê°€ì ¸ì˜´
    try {
      const result = yield call(promiseCreator, action.payload); // 1. promise ë°˜í™˜

      yield put({
        type: SUCCESS,
        payload: result
      }); // 2. ì„±ê³µ action dispatch
    } catch (err) {
      yield put({
        type: ERROR,
        error: true,
        payload: err
      }); // 2. ì‹¤íŒ¨ action dispatch
    }
  };
};
```
* `createPromiseThunk`ì™€ ìœ ì‚¬
* ìˆœìˆ˜ actionì´ dispatchë˜ë©´ `request action -> request success action -> request fail action` ìˆœì„œë¡œ ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬
* `promiseCreator`ì— í•„ìš”í•œ ì¸ìë¥¼ action.payloadë¡œ ë°›ê¸° ë•Œë¬¸ì— ë”°ë¡œ ë°›ì„ í•„ìš” ì—†ìŒ

> **src/modules/posts.js ì¤‘ ì¼ë¶€**
```javascript
import * as postAPI from "../api/posts";
import { handleAsyncActions, reducerUtils, createPromiseSaga } from "../lib/asyncUtils";

import { takeEvery } from "redux-saga/effects";

const GET_POSTS = "posts/GET_POSTS";
const GET_POSTS_SUCCESS = "posts/GET_POSTS_SUCCESS";
const GET_POSTS_ERROR = "posts/GET_POST_ERROR";

const GET_POST = "posts/GET_POST";
const GET_POST_SUCCESS = "posts/GET_POST_SUCCESS";
const GET_POST_ERROR = "posts/GET_POST_ERROR";

export const getPosts = () => ({ type: GET_POSTS });
export const getPost = (id) => ({
  type: GET_POST,
  payload: id,
  meta: id
});

// ê°ê° actionì´ ë°œìƒí–ˆì„ ë•Œ promiseì— ëŒ€í•œ ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬ saga ìƒì„±
const getPostsSaga = createPromiseSaga(GET_POSTS, postAPI.getPosts);
const getPostSaga = createPromiseSaga(GET_POST, postAPI.getPostById);

// saga ëª¨ë‹ˆí„°ë§ í•¨ìˆ˜ -> actionì´ ë°œìƒí•˜ë©´ saga ì‹¤í–‰
export function* postsSaga() {
  yield takeEvery(GET_POSTS, getPostsSaga);
  yield takeEvery(GET_POST, getPostSaga);
}

/* ì´í•˜ reducer ë³´ì¼ëŸ¬ í”Œë ˆì´íŠ¸ ê³¼ì • ìƒëµ ... */
```
* `postsSaga`ë¡œ ìƒì„±í•œ ë¹„ë™ê¸° ì²˜ë¦¬ sagaì™€ ìˆœìˆ˜ actionì„ ì—°ê²° -> í•´ë‹¹ action ë°œìƒ ì‹œ ë¶€í•©í•˜ëŠ” saga ì‹¤í–‰

## ğŸ”— ì°¸ê³ 

* [11-07-03. redux-sagaë¡œ Promise ë‹¤ë£¨ê¸° - ë¦¬íŒ©í† ë§](https://github.com/1000peach/React-Study/blob/master/11.%20Redux%20Middleware/11-07.%20redux-saga/03.%20redux-saga%EB%A1%9C%20Promise%20%EB%8B%A4%EB%A3%A8%EA%B8%B0/03.%20redux-saga%EB%A1%9C%20Promise%20%EB%8B%A4%EB%A3%A8%EA%B8%B0.md)